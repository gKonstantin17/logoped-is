<div class="details-header">
  <div class="tabs">
    <button [class.active]="selectedTab === 'lesson'" (click)="selectedTab = 'lesson'">–û—Å–Ω–æ–≤–Ω–æ–µ</button>
    <button [class.active]="selectedTab === 'about'" (click)="selectedTab = 'about'">–û –∑–∞–Ω—è—Ç–∏–∏</button>
    <button [class.active]="selectedTab === 'description'" (click)="selectedTab = 'description'">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
  </div>
  <div class="edit-btns" *ngIf="currentRole === 'logoped'">
    <ng-container *ngIf="isEditMode; else viewMode">
      <p>–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
      <button class="btn" (click)="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" (click)="saveChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </ng-container>
    <ng-template #viewMode>
      <img class="edit-btn" src="assets/details/edit.png" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" (click)="toggleEditMode()"/>
    </ng-template>
  </div>
</div>


<div class="tab-content" *ngIf="lesson$ | async as lesson">
  <!-- –í–∫–ª–∞–¥–∫–∞: –û—Å–Ω–æ–≤–Ω–æ–µ -->
  <ng-container *ngIf="selectedTab === 'lesson'">
    <div class="lesson-row">

      <!-- –ë–ª–æ–∫ 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div class="lesson-info block">
        <p>
          –í—ã –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ–π–¥–µ—Ç
          {{ lesson.dateOfLesson | date: 'd MMMM –≤ HH:mm' }}
        </p>
        <p><strong>–¢–∏–ø:</strong>
          <br>
          <span *ngIf="!isEditMode">{{ lesson.type }}</span>
          <select class="form-control" *ngIf="isEditMode" [(ngModel)]="editableLesson.type">
            <option *ngFor="let key of lessonTypeKeys" [ngValue]="key">
              {{ lessonTypeLabels[key] }}
            </option>
          </select>
        </p>
        <p><strong>–¢–µ–º–∞:</strong>
          <br>
          <span *ngIf="!isEditMode">{{ lesson.topic }}</span>
          <input class="form-control" *ngIf="isEditMode" type="text" [(ngModel)]="editableLesson.topic" />
        </p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ getStatusLabel(lesson.status) }}</p>
        <p><strong>–õ–æ–≥–æ–ø–µ–¥:</strong>  {{ lesson.logoped.firstName }} {{ lesson.logoped.lastName }}</p>
        <p><strong>–ü–∞—Ü–∏–µ–Ω—Ç—ã:</strong></p>

        <ng-container *ngIf="!isEditMode; else editPatients">
          <ul>
            <li *ngFor="let patient of editableLesson.patients">
              {{ patient.firstName }} {{ patient.secondName }}
            </li>
          </ul>
        </ng-container>

        <ng-template #editPatients>
          <div class="editable-patients">
            <ul>
              <li *ngFor="let patient of editableLesson.patients">
                {{ patient.firstName }} {{ patient.secondName }}
                <button type="button" class="btn-sm" (click)="removePatient(patient)">‚úñ</button>
              </li>
            </ul>

            <select [(ngModel)]="selectedPatientToAdd" class="form-control">
              <option [ngValue]="null">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</option>
              <option *ngFor="let patient of availablePatients()" [ngValue]="patient">
                {{ patient.firstName }} {{ patient.secondName }}
              </option>
            </select>
            <button type="button" class="btn-sm add-btn" (click)="addPatient()">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
        </ng-template>
      </div>

      <!-- –ë–ª–æ–∫ 2: –ö–∞—Ä—Ç–∏–Ω–∫–∞ -->
      <div class="lesson-image block">
        <img src="assets/details/details_main.png" alt="–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–Ω—è—Ç–∏—è" />
      </div>

      <!-- –ë–ª–æ–∫ 3: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
      <div class="lesson-notice block">
        <div class="notice-top">
          <p>üì© –ó–∞ —á–∞—Å –¥–æ –∑–∞–Ω—è—Ç–∏—è –º—ã –ø—Ä–∏—à–ª—ë–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</p>
        </div>
        <div class="notice-bottom">
          <p>üéô –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Ä–∞–±–æ—Ç–∞—é—Ç –ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –∫–∞–º–µ—Ä–∞</p>
        </div>
      </div>

    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="lesson-buttons">
      <button class="btn" *ngIf="(lesson.status === LessonStatus.STARTING_SOON || lesson.status === LessonStatus.IN_PROGRESS)
                                  && (lesson.type !== '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞' || currentRole === 'user')"
              (click)="openSession()">
        –û—Ç–∫—Ä—ã—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —É—Ä–æ–∫
      </button>
      <button class="btn" *ngIf="lesson.status === LessonStatus.PLANNED || lesson.status === LessonStatus.PLANNED_1H"  (click)="showRescheduleModal = true">
        –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–Ω—è—Ç–∏–µ
      </button>
      <button class="btn" *ngIf="lesson.status === LessonStatus.PLANNED || lesson.status === LessonStatus.PLANNED_1H"  (click)="cancelLesson()">
        –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ
      </button>
      <button class="btn" *ngIf="currentRole === 'logoped' && lesson.type === '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞'
            && (lesson.status === LessonStatus.STARTING_SOON || lesson.status === LessonStatus.IN_PROGRESS)"
              (click)="openDiagnostic()">
        –û—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
      </button>
    </div>

    <app-change-date-modal
      [visible]="showRescheduleModal"
      [patientId]="lesson?.patients?.[0]?.id"
      (close)="showRescheduleModal = false"
      (submit)="onReschedule($event)">
    </app-change-date-modal>
  </ng-container>


  <!-- –í–∫–ª–∞–¥–∫–∞: –û –∑–∞–Ω—è—Ç–∏–∏ -->
  <ng-container *ngIf="selectedTab === 'about'">
    <div class="block-row">
      <!-- –ë–ª–æ–∫: –û–ø–∏—Å–∞–Ω–∏–µ -->
      <div class="block">
        <h3 >–û–ø–∏—Å–∞–Ω–∏–µ</h3>
        <p *ngIf="!isEditMode">{{ lesson.description }}</p>
        <textarea *ngIf="isEditMode" class="form-control auto-resize" [(ngModel)]="editableLesson.description"
                  (input)="autoResize($event)"></textarea>
      </div>

      <!-- –ë–ª–æ–∫: –ú–∞—Ç–µ—Ä–∏–∞–ª—ã -->
      <div class="block">
        <h3>–ü—Ä–∏–ª–∞–≥–∞–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
        <a href="http://www.google.com">–§–∞–π–ª</a>
      </div>
    </div>
  </ng-container>

  <!-- –í–∫–ª–∞–¥–∫–∞: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
  <ng-container *ngIf="selectedTab === 'description'">
    <div class="block-row">
      <div class="block results">
        <h3>–ò—Ç–æ–≥–∏</h3>
        <div *ngIf="(changedCorrections?.added?.length || 0) + (changedCorrections?.removed?.length || 0) > 0">
          <table class="results-table">
            <thead>
            <tr>
              <th>–ó–≤—É–∫</th>
              <th>–î–æ</th>
              <th>–ü–æ—Å–ª–µ</th>
            </tr>
            </thead>
            <tbody>
            <!-- –Ω–æ–≤—ã–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ -->
            <tr *ngFor="let added of changedCorrections?.added">
              <td>{{ added.sound }}</td>
              <td>{{ getOldCorrection(added.sound) || '‚Äî' }}</td>
              <td>{{ added.correction }}</td>
            </tr>

            <!-- —Ç–æ–ª—å–∫–æ —É–¥–∞–ª—ë–Ω–Ω—ã–µ -->
            <tr *ngFor="let removed of changedCorrections?.removed">
              <ng-container *ngIf="isRemovedOnly(removed.sound)">
                <td>{{ removed.sound }}</td>
                <td>{{ removed.correction }}</td>
                <td>‚Äî</td>
              </ng-container>
            </tr>
            </tbody>
          </table>
        </div>


        <p *ngIf="changedCorrections?.added?.length === 0 && changedCorrections?.removed?.length === 0">
          –†–µ–∑—É–ª—å—Ç–∞—Ç - {{ getStatusLabel(lesson.status) }}
        </p>
      </div>

      <div class="block">
        <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <span *ngIf="!isEditMode">{{ editableLesson.homework?.task || '–ù–µ—Ç –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è' }}</span>
        <textarea *ngIf="isEditMode" class="form-control auto-resize"
                  [(ngModel)]="editableLesson.homework.task"
                  (input)="autoResize($event)"></textarea>
      </div>
    </div>
  </ng-container>
</div>
